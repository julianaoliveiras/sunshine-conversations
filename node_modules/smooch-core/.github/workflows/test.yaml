name: Test

on: 
  push:
    branches-ignore:
      - "master"

env:
    NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
    NODE_VERSION: '12.17'
    GITHUB_ACTIONS_TEST_REPORTS: '/tmp/test-results'

jobs:
    setup:
        runs-on: [self-hosted, zendesk-stable]
        steps:
            - name: Checkout
              uses: zendesk/checkout@v2

            - name: Setup NodeJS
              uses: zendesk/setup-node@v2
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - run: echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc

            # Will try to load an existing version of the packages from the cache
            - name: Cache NodeJS dependencies
              uses: zendesk/cache@v2
              id: node-cache
              with:
                  path: node_modules
                  key: ${{ runner.os }}-node_modules-${{ env.NODE_VERSION }}-${{ hashFiles('package-lock.json') }}

            # If no cached dependencies were available, install the dependencies
            - name: Install NodeJS dependencies
              if: steps.node-cache.outputs.cache-hit != 'true'
              run: npm install

    lint:
        runs-on: [self-hosted, zendesk-stable]
        needs: setup
        steps:
            - name: Checkout
              uses: zendesk/checkout@v2

            - name: Setup NodeJS
              uses: zendesk/setup-node@v2
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Cache NodeJS dependencies
              uses: zendesk/cache@v2
              id: node-cache
              with:
                  path: node_modules
                  key: ${{ runner.os }}-node_modules-${{ env.NODE_VERSION }}-${{ hashFiles('package-lock.json') }}

            - name: Run lint
              run: npm run lint

    prettier:
        runs-on: [self-hosted, zendesk-stable]
        needs: setup
        steps:
            - name: Checkout
              uses: zendesk/checkout@v2

            - name: Setup NodeJS
              uses: zendesk/setup-node@v2
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Cache NodeJS dependencies
              uses: zendesk/cache@v2
              id: node-cache
              with:
                  path: node_modules
                  key: ${{ runner.os }}-node_modules-${{ env.NODE_VERSION }}-${{ hashFiles('package-lock.json') }}

            - name: Run prettier
              run: npm run prettier:lint

    test:
        runs-on: [self-hosted, zendesk-stable]
        needs: setup
        steps:
            - name: Checkout
              uses: zendesk/checkout@v2

            - name: Setup NodeJS
              uses: zendesk/setup-node@v2
              with:
                  node-version: ${{ env.NODE_VERSION }}

            # Will try to load an existing version of the packages from the cache
            - name: Cache NodeJS dependencies
              uses: zendesk/cache@v2
              id: node-cache
              with:
                  path: node_modules
                  key: ${{ runner.os }}-node_modules-${{ env.NODE_VERSION }}-${{ hashFiles('package-lock.json') }}

            - name: Run mocha
              run: npm run test-ci

            - name: Archive code coverage results
              uses: zendesk/upload-artifact@v2
              with:
                  name: Test results
                  path: ${{ env.GITHUB_ACTIONS_TEST_REPORTS }}

    generate-docs:
        runs-on: [self-hosted, zendesk-stable]
        needs: setup
        steps:
            - name: Checkout
              uses: zendesk/checkout@v2

            - name: Setup NodeJS
              uses: zendesk/setup-node@v2
              with:
                  node-version: ${{ env.NODE_VERSION }}

            # Will try to load an existing version of the packages from the cache
            - name: Cache NodeJS dependencies
              uses: zendesk/cache@v2
              id: node-cache
              with:
                  path: node_modules
                  key: ${{ runner.os }}-node_modules-${{ env.NODE_VERSION }}-${{ hashFiles('package-lock.json') }}

            - name: Build docs
              run: npm run docs

            - name: Archive the docs
              uses: zendesk/upload-artifact@v2
              with:
                  name: docs
                  path: out
